generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////
// üßë Utilisateur
//////////////////////////////////////////

model User {
  id                 String    @id @default(auto()) @map("_id") @db.ObjectId
  name               String?
  email              String    @unique
  emailVerified      DateTime?
  password           String?   // Pour l'auth par credentials
  image              String?
  calendarVisibility Boolean   @default(true) // true = visible aux amis
  themeColor         String    @default("blue") // "blue" | "purple" | "emerald" | "rose" | "pink" | "orange" | "amber"
  themeMode          String    @default("dark") // "dark" | "light"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

//////////////////////////////////////////
// üìÖ Types d'√©v√©nements
//////////////////////////////////////////

model EventType {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   // Nom du type (ex: "Travail", "Perso", "Important")
  color       String   // Couleur en hex (ex: "#ff5733")
  userId      String   @db.ObjectId // Chaque utilisateur a ses propres types

  events      Event[]  @relation("EventToEventType")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("event_types")
}

//////////////////////////////////////////
// üìÖ √âv√©nements
//////////////////////////////////////////

model Event {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  date        DateTime
  location    String?
  visibility  String   @default("friends") // "public" | "friends" | "private"
  createdById String   @db.ObjectId // R√©f√©rence sans relation Prisma
  eventTypeId String?  @db.ObjectId // Type d'√©v√©nement (optionnel)

  eventType   EventType? @relation("EventToEventType", fields: [eventTypeId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("events")
}

//////////////////////////////////////////
// üë• Participants d'√©v√©nements
//////////////////////////////////////////

model EventParticipant {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  eventId   String   @db.ObjectId // R√©f√©rence √† l'√©v√©nement
  userId    String   @db.ObjectId // R√©f√©rence √† l'utilisateur invit√©
  status    String   @default("pending") // "pending" | "accepted" | "declined"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, userId]) // Un utilisateur ne peut √™tre qu'une fois par √©v√©nement
  @@map("event_participants")
}

//////////////////////////////////////////
// üë• Amis
//////////////////////////////////////////

model Friend {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId // R√©f√©rence sans relation Prisma
  friendId  String   @db.ObjectId // R√©f√©rence sans relation Prisma
  status    String   @default("pending") // "pending" | "accepted" | "blocked"

  createdAt DateTime @default(now())

  @@map("friends")
}

//////////////////////////////////////////
// üîî Abonnements Push
//////////////////////////////////////////

model PushSubscription {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId // R√©f√©rence √† l'utilisateur
  endpoint     String   @unique
  p256dh       String   // Cl√© publique pour le chiffrement
  auth         String   // Secret d'authentification
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("push_subscriptions")
}

//////////////////////////////////////////
// üó≥Ô∏è Sondages (Polls)
//////////////////////////////////////////

model Poll {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  question     String
  createdById  String    @db.ObjectId
  recipientIds String[]  @db.ObjectId
  status       String    @default("open") // "open" | "resolved" | "cancelled"
  deadline     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("polls")
}

model PollOption {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  pollId  String @db.ObjectId
  text    String

  createdAt DateTime @default(now())

  @@map("poll_options")
}

model PollVote {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  pollId   String   @db.ObjectId
  optionId String   @db.ObjectId
  userId   String   @db.ObjectId

  createdAt DateTime @default(now())

  @@unique([pollId, userId]) // Un utilisateur ne peut voter qu'une fois par sondage
  @@map("poll_votes")
}

//////////////////////////////////////////
// üîî Notifications
//////////////////////////////////////////

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId // Destinataire de la notification
  type      String   // "friend_request" | "event_invitation" | "poll" | "event_update"
  title     String
  message   String
  link      String?  // URL vers la ressource concern√©e
  read      Boolean  @default(false)
  fromUserId String? @db.ObjectId // ID de l'utilisateur qui a d√©clench√© la notification

  createdAt DateTime @default(now())

  @@map("notifications")
}


